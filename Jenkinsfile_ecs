pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-northeast-1'
        ACCOUNT_ID = '626635430480'
        ECR_REPOSITORY = 'python-web-app'
        ECR_REGISTRY = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        ECS_CLUSTER = 'ecs-python-web-app'
        ECS_SERVICE = 'python-web-app-task-service-laple3tl'
        ECS_TASK_FAMILY = 'python-web-app-task'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                    docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} .
                    docker build -t ${ECR_REPOSITORY}:latest .
                '''
            }
        }

        stage('Login to ECR') {
            steps {
                sh '''
                    aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${ECR_REGISTRY}
                '''
            }
        }

        stage('Push to ECR') {
            steps {
                sh '''
                    docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                    docker tag ${ECR_REPOSITORY}:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

                    docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                    docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                '''
            }
        }

        stage('Update ECS Task Definition') {
            steps {
                echo 'Updating ECS Task Definition with new image...'
                sh '''
                    # í˜„ìž¬ Task Definition ê°€ì ¸ì˜¤ê¸°
                    CURRENT_TASK_DEF=$(aws ecs describe-task-definition \
                        --task-definition ${ECS_TASK_FAMILY} \
                        --region ${AWS_REGION} \
                        --query 'taskDefinition' --output json)

                    # ìƒˆ ì´ë¯¸ì§€ë¡œ Task Definition ì—…ë°ì´íŠ¸
                    NEW_TASK_DEF=$(echo $CURRENT_TASK_DEF | jq --arg IMAGE "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}" \
                        '.containerDefinitions[0].image = $IMAGE' | \
                        jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)')

                    # ìƒˆ Task Definition ë“±ë¡
                    NEW_TASK_DEF_ARN=$(echo $NEW_TASK_DEF | aws ecs register-task-definition \
                        --region ${AWS_REGION} \
                        --cli-input-json file:///dev/stdin \
                        --query 'taskDefinition.taskDefinitionArn' --output text)

                    echo "âœ… New Task Definition registered: $NEW_TASK_DEF_ARN"
                    echo "ðŸ“¦ Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                '''
            }
        }

        stage('Deploy to ECS') {
            steps {
                echo 'Deploying to ECS Service...'
                sh '''
                    # ECS Service ì—…ë°ì´íŠ¸ (ìƒˆ Task Definitionìœ¼ë¡œ ë°°í¬)
                    echo "Updating ECS Service: ${ECS_SERVICE} in cluster: ${ECS_CLUSTER}"

                    UPDATE_RESULT=$(aws ecs update-service \
                        --cluster ${ECS_CLUSTER} \
                        --service ${ECS_SERVICE} \
                        --task-definition ${ECS_TASK_FAMILY} \
                        --region ${AWS_REGION} \
                        --query 'service.{ServiceName:serviceName,TaskDefinition:taskDefinition,DesiredCount:desiredCount}' \
                        --output json)

                    echo "âœ… ECS Service update initiated"
                    echo "ðŸ“‹ Update details: $UPDATE_RESULT"

                    # ë°°í¬ ìƒíƒœ í™•ì¸ (2ë¶„ ëŒ€ê¸°)
                    echo "â³ Monitoring deployment progress..."
                    sleep 120

                    # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
                    SERVICE_STATUS=$(aws ecs describe-services \
                        --cluster ${ECS_CLUSTER} \
                        --services ${ECS_SERVICE} \
                        --region ${AWS_REGION} \
                        --query 'services[0].{Status:status,RunningCount:runningCount,DesiredCount:desiredCount,DeploymentStatus:deployments[0].status}' \
                        --output json)

                    echo "ðŸ“Š Current service status: $SERVICE_STATUS"

                    RUNNING_COUNT=$(echo $SERVICE_STATUS | jq -r '.RunningCount')
                    DESIRED_COUNT=$(echo $SERVICE_STATUS | jq -r '.DesiredCount')
                    DEPLOYMENT_STATUS=$(echo $SERVICE_STATUS | jq -r '.DeploymentStatus')

                    echo "Running tasks: $RUNNING_COUNT / $DESIRED_COUNT"
                    echo "Deployment status: $DEPLOYMENT_STATUS"

                    if [ "$DEPLOYMENT_STATUS" = "PRIMARY" ] && [ "$RUNNING_COUNT" = "$DESIRED_COUNT" ]; then
                        echo "âœ… Deployment completed successfully"
                    else
                        echo "âš ï¸ Deployment is still in progress"
                        echo "ðŸ“‹ Monitor in AWS Console: ECS â†’ Clusters â†’ ${ECS_CLUSTER} â†’ Services â†’ ${ECS_SERVICE}"
                    fi
                '''
            }
        }
    }

    post {
        success {
            echo 'ðŸŽ‰ ECS Pipeline completed successfully!'
            echo "ðŸ³ Docker Image: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
            echo "ðŸš€ ECS Cluster: ${ECS_CLUSTER}"
            echo "ðŸ“¦ ECS Service: ${ECS_SERVICE}"
            echo "ðŸ“‹ Task Definition: ${ECS_TASK_FAMILY}"
            sh '''
                # ë°°í¬ëœ Task ì •ë³´ ì¶œë ¥
                echo "ðŸ” Current running tasks:"
                aws ecs list-tasks \
                    --cluster ${ECS_CLUSTER} \
                    --service-name ${ECS_SERVICE} \
                    --region ${AWS_REGION} \
                    --desired-status RUNNING \
                    --query 'taskArns' --output table

                # Task ìƒì„¸ ì •ë³´ (Public IP ë“±)
                TASK_ARNS=$(aws ecs list-tasks \
                    --cluster ${ECS_CLUSTER} \
                    --service-name ${ECS_SERVICE} \
                    --region ${AWS_REGION} \
                    --desired-status RUNNING \
                    --query 'taskArns[0]' --output text)

                if [ "$TASK_ARNS" != "None" ] && [ "$TASK_ARNS" != "" ]; then
                    echo "ðŸ“ Task details:"
                    aws ecs describe-tasks \
                        --cluster ${ECS_CLUSTER} \
                        --tasks $TASK_ARNS \
                        --region ${AWS_REGION} \
                        --query 'tasks[0].{TaskArn:taskArn,LastStatus:lastStatus,HealthStatus:healthStatus}' \
                        --output table
                fi
            '''
        }
        failure {
            echo 'âŒ Pipeline failed!'
            sh '''
                # ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                echo "ðŸ” ECS Service status:"
                aws ecs describe-services \
                    --cluster ${ECS_CLUSTER} \
                    --services ${ECS_SERVICE} \
                    --region ${AWS_REGION} \
                    --query 'services[0].{Status:status,RunningCount:runningCount,PendingCount:pendingCount}' \
                    --output table 2>/dev/null || echo "Failed to get service status"

                echo "ðŸ“‹ Recent service events:"
                aws ecs describe-services \
                    --cluster ${ECS_CLUSTER} \
                    --services ${ECS_SERVICE} \
                    --region ${AWS_REGION} \
                    --query 'services[0].events[:3]' \
                    --output table 2>/dev/null || echo "Failed to get service events"
            '''
        }
        cleanup {
            sh '''
                docker rmi ${ECR_REPOSITORY}:${IMAGE_TAG} || true
                docker rmi ${ECR_REPOSITORY}:latest || true
                docker rmi ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} || true
                docker rmi ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest || true
            '''
        }
    }
}